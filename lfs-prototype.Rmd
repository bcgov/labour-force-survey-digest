---
title: "B.C. Labour Force Summary"
output: 
  flexdashboard::flex_dashboard:
    theme: yeti
    orientation: columns
    vertical_layout: scroll
    social: menu
    source_code: https://github.com/bcgov/labour-force-survey-digest
---
 

<!--
Copyright 2020 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->


```{r setup, include=FALSE, cache=TRUE}
#load libraries in setup.R
source("setup.R")

#source data
# source("get-data.R")
lfc_province_tidy <- readRDS("tmp/lfc_province_tidy.rds")
lfc_region_tidy <- readRDS("tmp/lfc_region_tidy.rds")
employment_by_class_tidy <- readRDS("tmp/employment_by_class_tidy.rds")

#report month
report_month <- month(Sys.Date() %m-% months(1),
        label = TRUE, abbr = FALSE)

#report year
report_year <- year(Sys.Date())
previous_year <- year(Sys.Date()) - 1

# title_var <- paste("B.C. Labour Force Summary for", report_month, report_year)

#common chart themes
theme_vert_bar <- theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.line = element_line(colour = "grey50"),
    axis.text = element_text(size = 11),
    legend.text = element_text(size = 11))

theme_horiz_bar <- theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    axis.line = element_line(colour = "grey50"),
    axis.text = element_text(size = 11),
    legend.text = element_text(size = 11))

theme_facet_bar <- theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.line = element_line(colour = "grey50"),
    axis.text.y = element_text(size = 11),
    axis.text.x = element_text(size = 9),
    strip.text = element_text(size = 11))
```


Sidebar {.sidebar}
=======================================================================

## `r paste(report_month, report_year)`

Labour Force Survey summaries for British Columbia:

 - [Employment]
 - [Unemployment]
 - [Other Provinces]
 
Learn more [About] the Statistics Canada Labour Force Survey.


Employment
======================================================================


Column {data-width=500}
-----------------------------------------------------------------------


### Recent Month Change in B.C. Employment {.value-box}

```{r}
#recent monthly change in employment
recent_month_change_employment <- lfc_province_tidy %>%
  filter(vector == "v2064701",
         date == max(date))

valueBox(
  value = recent_month_change_employment %>%
    pull(month_change) %>%
    signs(format = comma,
          add_plusses = TRUE),
  icon = "fa-users-cog",
  caption = paste("Change in B.C. Employment in", report_month)
)
```


### Monthly Change in B.C. Employment in `r report_year` 

```{r, fig.width=7, fig.height=5}
p1 <- lfc_province_tidy %>%
  filter(vector == "v2064701",
         date > "2019-12-01") %>%
  ggplot(aes(
    x = date,
    y = month_change,
    text = paste(
      "Month-Over-Month Change:",
      signs(
       month_change,
       format = comma,
       add_plusses = TRUE),
      "<br>",
      "% Month-Over-Month Change:",
      signs(
        month_change_percent,
        format = percent,
        add_plusses = TRUE,
        accuracy = 0.1
      )
    )
  )) +
  geom_col(fill = "#1d91c0", alpha = 0.6) +
  geom_text(
    aes(
      label = signs(
        month_change_percent,
        format = percent,
        add_plusses = TRUE,
        accuracy = 0.1
      )
    ),
    nudge_y = -13000,
    colour = "grey20",
    size = 3
  ) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = comma,
                     breaks = breaks_pretty(n = 8)) +
  theme_minimal() +
  theme_vert_bar

ggplotly(p1, tooltip = c("text"))
```


### Monthly Change in B.C. Employment by Age & Gender in `r report_year` 

```{r, fig.width=7, fig.height=5}
p2 <- lfc_province_tidy %>%
  filter(
    date > "2019-12-01",
    geo == "British Columbia",
    labour_force_characteristics == "Employment",
    age_group %in% c("15 to 24 years",
                     "25 to 54 years",
                     "55 years and over")
  ) %>%
  mutate(sex = recode(sex, "Both sexes" = "All")) %>%
  filter(sex != "All") %>%
  ggplot(aes(
    x = date,
    y = month_change,
    text = paste(
      "Month-Over-Month Change:",
      signs(month_change,
            format = comma,
            add_plusses = TRUE),
      "<br>",
      "% Month-Over-Month Change:",
      signs(
        month_change_percent,
        format = percent,
        add_plusses = TRUE,
        accuracy = 0.1
      )
    )
  )) +
  geom_col(fill = "#1d91c0", alpha = 0.6) +
  facet_grid(sex ~ age_group) +
  geom_text(
    aes(
      label = signs(
        month_change_percent,
        format = percent,
        add_plusses = TRUE,
        accuracy = 0.1
      )
    ),
    nudge_y = -5000,
    colour = "grey20",
    size = 2
  ) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = comma,
                     breaks = breaks_pretty(5)) +
  theme_minimal() +
  theme_facet_bar
# theme(strip.text.y = element_text(angle = 0))

ggplotly(p2, tooltip = c("text"))
```


Column {data-width=500}
-----------------------------------------------------------------------

### % Recent Month Change in Employment {.value-box}

```{r}
valueBox(
  value = recent_month_change_employment %>%
    pull(month_change_percent) %>%
    signs(
      format = percent,
      add_plusses = TRUE,
      accuracy = 0.1
    ),
  icon = "fa-users-cog",
  caption = paste("% Change in B.C. Employment in", report_month)
)
```


### Monthly Change in B.C. Employment by Sector in `r report_year` 

```{r, fig.width=7, fig.height=5}
p3 <- employment_by_class_tidy %>%
  filter(
    class_of_worker %in% c(
      "Public sector employees",
      "Private sector employees",
      "Self-employed"
    ),
    date > "2019-12-01"
  ) %>%
  mutate(class_of_worker = str_remove(class_of_worker, " employees")) %>%
  ggplot(aes(
    x = date,
    y = month_change,
    text = paste(
      "Month-Over-Month Change:",
      signs(month_change,
            format = comma,
            add_plusses = TRUE),
      "<br>",
      "% Month-Over-Month Change:",
      signs(
        month_change_percent,
        format = percent,
        add_plusses = TRUE,
        accuracy = 0.1
      )
    )
  )) +
  geom_col(fill = "#1d91c0", alpha = 0.6) +
  facet_wrap(
    facets = vars(class_of_worker)
    # labeller = labeller(class_of_worker = label_wrap_gen(width = 15))
  ) +
  geom_text(
    aes(
      label = signs(
        month_change_percent,
        format = percent,
        add_plusses = TRUE,
        accuracy = 0.1
      )
    ),
    nudge_y = -8000,
    colour = "grey20",
    size = 2.5
  ) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = comma,
                     breaks = breaks_pretty(n = 6)) +
  theme_minimal() +
  theme_facet_bar

ggplotly(p3, tooltip = c("text"))
```


### Monthly Change in B.C. Employment by Job Type in `r report_year` 

```{r, fig.width=7, fig.height=5}
p4 <- lfc_province_tidy %>%
  filter(
    date > "2019-12-01",
    geo == "British Columbia",
    labour_force_characteristics %in% c("Full-time employment",
                                        "Part-time employment"),
    sex == "Both sexes",
    age_group == "15 years and over"
  ) %>%
  mutate(labour_force_characteristics = str_extract(labour_force_characteristics,
                                                   "^([^,])+ ")) %>% 
  ggplot(aes(
    x = date,
    y = month_change,
    text = paste(
      "Month-Over-Month Change:",
      signs(month_change,
            format = comma,
            add_plusses = TRUE),
      "<br>",
      "% Month-Over-Month Change:",
      signs(
        month_change_percent,
        format = percent,
        add_plusses = TRUE,
        accuracy = 0.1
      )
    )
  )) +
  geom_col(fill = "#1d91c0", alpha = 0.6) +
  facet_wrap(
    facets = vars(labour_force_characteristics),
    labeller = labeller(labour_force_characteristics = label_wrap_gen(width = 10))
  ) +
  geom_text(
    aes(
      label = signs(
        month_change_percent,
        format = percent,
        add_plusses = TRUE,
        accuracy = 0.1
      )
    ),
    nudge_y = -7000,
    colour = "grey20",
    size = 2.5
  ) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = comma,
                     breaks = breaks_pretty(n = 6)) +
  theme_minimal() +
  theme_facet_bar

ggplotly(p4, tooltip = c("text"))
```



Unemployment
======================================================================


Column 
-----------------------------------------------------------------------


### Recent Month Change in Unemployment {.value-box}

```{r}
#recent monthly change in unemployment
recent_month_change_unemployment <- lfc_province_tidy %>%
  filter(vector == "v2064704",
         date == max(date))

valueBox(
  value = recent_month_change_unemployment %>%
    pull(month_change) %>%
    signs(format = comma, add_plusses = TRUE),
  icon = "fa-users-cog",
  caption = paste("Change in B.C. Unemployment in", report_month)
)
```


### Monthly Change in B.C. Unemployment in `r report_year` 

```{r, fig.width=7, fig.height=5}
p5 <- lfc_province_tidy %>%
  filter(vector == "v2064704",
         date > "2019-12-01") %>%
  ggplot(aes(
    x = date,
    y = value,
    text = paste(
      "Month-Over-Month Change in Unemployment:",
      signs(month_change,
            format = comma,
            add_plusses = TRUE),
      "<br>",
      "% Month-Over-Month Change:",
      signs(
        month_change_percent,
        format = percent,
        add_plusses = TRUE,
        accuracy = 0.1
      )
    )
  )) +
  geom_col(fill = "#1d91c0", alpha = 0.6) +
  geom_text(
    aes(label = signs(
      month_change,
      format = comma,
      add_plusses = TRUE
    )),
    nudge_y = -9000,
    colour = "grey20",
    size = 3
  ) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = comma,
                     expand = c(0, 0),
                     breaks = breaks_pretty(n = 6)) +
  theme_minimal() +
  theme_vert_bar


ggplotly(p5, tooltip = c("text"))
```

### Unemployment Rates for `r report_month` by B.C. Economic Region 

```{r, fig.width=7, fig.height=5}
# p6 <- 
lfc_region_tidy %>%
  filter(
    geo != "British Columbia",
    labour_force_characteristics == "Unemployment rate",
    date == max(date)
  ) %>%
  mutate(geo_label = str_wrap(str_extract(geo, "^([^,])+"), width = 10)) %>%
  st_as_sf() %>%
  rmapshaper::ms_clip(bcmaps::bc_bound(class = "sf")) %>%
  ggplot() +
  geom_sf(aes(fill = value),
          colour = "white",
          lwd = .2) +
  geom_sf_text(aes(label = geo_label),
               size = 2.5,
               colour = "white") +
  coord_sf(datum = NA) +
  labs(x = NULL, y = NULL,
       caption = "(3-month-moving-avg, seasonally unadjusted)") +
  scale_fill_viridis(
    name = paste("Unemployment Rate\nfor",
                 report_month,
                 report_year),
    direction = -1,
    labels = percent_format(accuracy = 1),
    breaks = breaks_pretty(n = 4)
  ) +
  theme_minimal() +
  theme(
    legend.title = element_text(size = 10),
    plot.caption = element_text(
      size = 8,
      colour = "grey60",
      face = "italic",
      hjust = 1.3
    )
  )

# plotly::ggplotly(p6) 
```


Column 
-----------------------------------------------------------------------

### Unemployment Rate (%) for Recent Month {.value-box}

```{r}
#recent monthly change in unemployment
recent_month_unemployment_rate <- lfc_province_tidy %>%
  filter(vector == "v2064705",
         date == max(date))


valueBox(
  value = recent_month_unemployment_rate %>%
    pull(value) %>%
    signs(format = percent, accuracy = 0.1),
  icon = "fa-users-cog",
  caption = paste("B.C. Unemployment Rate in", report_month)
)
```


### Monthly B.C. Unemployment Rates Over Time 

```{r, fig.width=7, fig.height=5}
p7 <- lfc_province_tidy %>%
  filter(vector == "v2064705") %>%
  ggplot(aes(x = date,
             y = value,
             text = paste( 
      "Date:",
      date,
      "<br>",
    "Unemployment Rate:",
    signs(value,
          format = percent,
          accuracy = 0.1)
  ))) +
  geom_point(colour = "#1d91c0",
             alpha = 0.6) +
  geom_line(colour = "#1d91c0",
            alpha = 0.8) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = percent,
                     breaks = breaks_pretty(n = 6)) +
  theme_minimal() +
  theme_vert_bar

ggplotly(p7, tooltip = c("text"))
```

### Monthly B.C. Unemployment Rates by Age & Sex for Previous 10 Years

```{r, fig.width=7, fig.height=5}
p8 <- lfc_province_tidy %>%
  filter(
    date > "2009-12-01",
    geo == "British Columbia",
    labour_force_characteristics %in% c("Unemployment rate"),
    age_group %in% c("15 to 24 years",
                     "25 to 54 years",
                     "55 years and over"),
    sex != "Both sexes"
  ) %>%
  ggplot(aes(
    x = date,
    y = value,
    colour = age_group,
    text = paste(
      "Date:",
      date,
      "<br>",
      "Age Group:",
      age_group,
      "<br>",
      "Unemployment Rate:",
      signs(value,
            format = percent,
            accuracy = 0.1)
    )
  )) +
  geom_point(alpha = 0.6) +
  geom_line(alpha = 0.8) +
  facet_wrap(facets = vars(sex)) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = percent,
                     breaks = breaks_pretty(n = 6)) +
  scale_colour_viridis_d() +
  theme_minimal() +
  theme_vert_bar

ggplotly(p8, tooltip = c("text")) %>%
  layout(legend = list(
    orientation = "h",
    x = 0.1,
    y = -0.2
  ))
```

Other Provinces 
======================================================================


Column
-----------------------------------------------------------------------

### Change in Employment by Province in `r report_month` {data-width=500}


```{r}
lim <- c(0,
         lfc_province_tidy %>%
  ungroup() %>% 
  filter(labour_force_characteristics == "Employment",
         sex == "Both sexes",
         age_group == "15 years and over",
         date == max(date),
         geo != "Canada") %>% 
  slice_max(month_change, n = 1) %>% 
  pull(month_change) + 50000
)

lfc_province_tidy %>% 
  filter(labour_force_characteristics == "Employment",
         sex == "Both sexes",
         age_group == "15 years and over",
         date > "2019-12-01" ) %>%
  filter(date == max(date),
         geo != "Canada") %>% 
  mutate(fill_col = ifelse(geo == "British Columbia", "bc", "other")) %>% 
  ggplot(aes(x = reorder(geo, -month_change), y = month_change)) +
  geom_col(aes(fill = fill_col), alpha = 0.6) +
  coord_flip() +
  geom_text(aes(label = signs(month_change_percent,
                              format = percent,
                              add_plusses = TRUE,
                              accuracy = 0.1)),
            nudge_y = 25000, colour = "grey30", size = 3.5) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = comma,
                     expand = c(0, 0),
                     limits = lim) +
  scale_fill_manual(guide = FALSE,
                    values = c(bc = "#FDE725FF",
                               other = "#365C8DFF")) +
  theme_minimal() +
  theme_horiz_bar
```


Column
-----------------------------------------------------------------------

### Year Change in Employment {.value-box}

```{r}
year_change_employment <- lfc_province_tidy %>%
  filter(vector == "v2064701",
         date %in% c(max(date) - months(12), max(date))) %>% 
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>% 
  filter(date == max(date))

#year over year change employment
valueBox(value = year_change_employment %>% 
  pull(year_change) %>%
  signs(format = comma, ),
         icon = "fa-users-cog",
         caption = paste("Year-Over-Year Change in B.C. Employment"))
```


### % Year Change in Employment {.value-box}

```{r}
#year over year change employment
valueBox(value = year_change_employment %>% 
  pull(year_change_percent) %>%
  signs(format = percent, add_plusses = TRUE, accuracy = 0.1),
         icon = "fa-users-cog",
         caption = paste("% Year-Over-Year Change in B.C. Employment"))
```


About
======================================================================


Column
-----------------------------------------------------------------------


Data are sourced from the [Statistics Canada Labour Force Survey (LFS)](https://www.statcan.gc.ca/eng/survey/household/3701), a monthly survey which measures the current state of the Canadian labour market. 
  
Statistics Canada data are released under the [Statistics Canada Open Licence](https://www.statcan.gc.ca/eng/reference/licence).
  
Statistics Canada Labour Force Survey Tables: 

 - [Statistics Canada Table **14-10-0287-03**: Labour force characteristics by province, monthly, seasonally adjusted](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410028703)
 - [Statistics Canada Table **14-10-0293-02**: Labour force characteristics by economic region, three-month moving average, unadjusted for seasonality](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410029302)
 - [Statistics Canada Table **14-10-0288-01**: Employment by class of worker, monthly, seasonally adjusted and unadjusted, last 5 months](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410028801)
 - [Statistics Canada Table **14-10-0127-01**: Reason for not looking for work, monthly, unadjusted for seasonality](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410012701&pickMembers%5B0%5D=1.11&pickMembers%5B1%5D=3.1&pickMembers%5B2%5D=4.1)
 
B.C. Data Catalogue:
 - [Current Census Economic Regions](https://catalogue.data.gov.bc.ca/dataset/1aebc451-a41c-496f-8b18-6f414cde93b7)

This report is built with the [`flexdashboard` R package](https://rmarkdown.rstudio.com/flexdashboard/), sourcing the Statistics Canada Labour Force Survey data using the [`cansim` R package](https://mountainmath.github.io/cansim/index.html), and the British Columbia economic geospatial data using the [`bcdata` R package](https://bcgov.github.io/bcdata/). 
  
The [R](https://www.r-project.org/) code is available in bcgov GitHub [here](https://github.com/bcgov/labour-force-survey-digest), available under the [Apache 2.0 licence](https://github.com/bcgov/labour-force-survey-digest/blob/master/LICENSE).
