---
title: "Labour Force Survey: British Columbia"
output: 
  flexdashboard::flex_dashboard:
    theme: yeti
    orientation: rows
    vertical_layout: scroll
    social: menu
    source_code: https://github.com/bcgov/labour-force-survey-digest
---


<!--
Copyright 2020 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->


```{r setup, include=FALSE, cache=TRUE}
##load libraries in setup.R
source("setup.R")

##source data
##source("get-data.R")
lfc_province_tidy <- readRDS("tmp/lfc_province_tidy.rds")
lfc_region_tidy <- readRDS("tmp/lfc_region_tidy.rds")
employment_by_class_tidy <- readRDS("tmp/employment_by_class_tidy.rds")
can_provinces <- readRDS("tmp/can_provinces.rds")
employment_by_industry_tidy <- readRDS("tmp/employment_by_industry_tidy.rds")
lfs_industry_unadjusted_tidy <- readRDS("tmp/lfs_industry_unadjusted_tidy.rds")

##report month
report_month <- lfc_province_tidy %>%
  filter(vector == "v2064705",
         date == max(date)) %>%
  pull(date) %>%
  month(label = TRUE, abbr = FALSE)

##report year
report_year <- lfc_province_tidy %>%
  filter(vector == "v2064705",
         date == max(date)) %>%
  pull(date) %>%
  year()

##previous report year
previous_year <- report_year - 1

##common chart themes
theme_bar <- theme(
  axis.line = element_line(colour = "grey70", size = .1),
  axis.text = element_text(size = 9),
  legend.text = element_text(size = 11, colour = "grey20")
)

theme_vert <- theme_bar +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  )

theme_horiz <- theme_bar +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank()
  )

theme_facet <- theme_vert +
  theme(
    axis.text.y = element_text(size = 9),
    axis.text.x = element_text(size = 8),
    strip.text = element_text(size = 11, colour = "grey20"),
    legend.text = element_text(size = 11, colour = "grey20")
  )

##colours
main_colour <- "#1d91c0"

##labels
gender_labels <-  c("Males" = "Men",
                    "Females" = "Women")

##custom ggplotly
ggplotly_lfs <- function(...) {
  ggplotly(..., tooltip = c("text"))
}

## A formatted date
report_prov_date <- format(max(lfc_province_tidy$date), "%B %Y")

## Some html objects for tables
up_arrow <- "<span style=\"color:#472D7BFF\">&#9650;</span>"
down_arrow <- "<span style=\"color:#27AD81FF\">&#9660;</span>"
```

Sidebar {.sidebar data-width=200}
=======================================================================

### `r paste(report_month, report_year)`

<br>

Labour Force Survey Summary for British Columbia:

 - [Highlights]
 - [Demographics]
 - [Job Type]
 - [Industry]
 - [COVID-19]

<br>

ðŸ–± Click or tap on graphs for some interactive options:

![](images/plotly-options.png){width=90%}

<br>

Learn more [About] the Statistics Canada Labour Force Survey.


Highlights
======================================================================

Row 1
----------------------------------------------------------------------

### B.C. Unemployment Rate for Recent Month {.value-box}

```{r}
##recent month unemployment rate
recent_month_unemployment_rate_bc <- lfc_province_tidy %>%
  filter(
    vector == "v2064705",
    date == max(date)
  )

valueBox(
  value = recent_month_unemployment_rate_bc %>%
    pull(value) %>%
    signs(format = percent, accuracy = 0.1),
  # icon = "fa-users-cog",
  caption = paste("B.C. Unemployment Rate for", report_month, report_year)
)
```

### Month-Over-Month Change in B.C. Unemployment Rate {.value-box}

```{r}
valueBox(
  value = recent_month_unemployment_rate_bc %>%
    pull(month_change) %>%
    signs(format = percent, accuracy = 0.1),
  # icon = "fa-users-cog",
  caption = "Month-Over-Month Change in B.C. Unemployment Rate"
)
```

### Year-Over-Year Change in B.C. Unemployment Rate {.value-box}

```{r}
##year over year change unemployment rate
year_change_unemployment_rate_bc <- lfc_province_tidy %>%
  filter(
    vector == "v2064705",
    date %in% c(max(date) - months(12), max(date))
  ) %>%
  mutate(year_change = value - lag(value)) %>%
  filter(date == max(date))

valueBox(
  value = year_change_unemployment_rate_bc %>%
    pull(year_change) %>%
    signs(
      format = percent,
      add_plusses = TRUE,
      accuracy = 0.1
    ),
  # icon = "fa-users-cog",
  caption = paste("Year-Over-Year Change in B.C. Unemployment Rate")
)
```

Row 2
----------------------------------------------------------------------

### Monthly B.C. Unemployment Rates Since 2000 

```{r, fig.width=7, fig.height=5}
unemployrt_pre_thisyear <- lfc_province_tidy %>%
  filter(vector == "v2064705",
         date > "1999-12-31" & date < paste0(report_year, "-01-01"))

unemployrt_thisyear <- lfc_province_tidy %>%
  filter(vector == "v2064705",
         date >= paste0(report_year, "-01-01"))

ggplotly_lfs(
  ggplot() +
  geom_point(
    data = unemployrt_thisyear,
    aes(
      x = date,
      y = value,
      text = paste0(
        "Date: ",
        date,
        "<br>",
        "Unemployment Rate: ",
        signs(value,
              format = percent,
              accuracy = 0.1)
      )
    ),
    colour = main_colour,
    alpha = 0.8
  ) +
  geom_point(
    data = unemployrt_pre_thisyear,
    aes(
      x = date,
      y = value,
      text = paste(
        "Date:",
        date,
        "<br>",
        "Unemployment Rate:",
        signs(value,
              format = percent,
              accuracy = 0.1)
      )
    ),
    colour = "grey50",
    alpha = 0.8
  ) +
  geom_line(
    data = unemployrt_thisyear,
    aes(x = date,
        y = value),
    colour = main_colour,
    alpha = 0.8
  ) +
  geom_line(
    data = unemployrt_pre_thisyear,
    aes(x = date,
        y = value),
    colour = "grey50",
    alpha = 0.8
  ) +
  labs(x = NULL, y = NULL) +
  scale_y_continuous(labels = percent,
                     breaks = breaks_pretty(n = 5)) +
  theme_minimal() +
  theme_vert
)
```

### Unemployment Rates by B.C. Economic Region for `r paste(report_month, report_year)` 

```{r, fig.width=7, fig.height=5}
lfc_region_tidy %>%
    filter(
      geo != "British Columbia",
      labour_force_characteristics == "Unemployment rate",
      date == max(date)
    ) %>%
    mutate(geo_label = str_wrap(str_extract(geo, "^([^,])+"), width = 10)) %>%
    ggplot() +
    geom_sf(
      aes(
        fill = value,
        text = paste0(
          "Region: ",
          geo_label,
          "<br>",
          "Date: ",
          date,
          "<br>",
          "Unemployment Rate: ",
          signs(value,
                format = percent,
                accuracy = 0.1)
        )
      ),
      colour = "white",
      lwd = .2
    ) +
    geom_sf_text(aes(label = geo_label),
                 size = 3.5,
                 colour = "grey20") +
    # coord_sf(datum = NA) +
    labs(x = NULL, y = NULL,
         caption = "(3-month-moving-avg, seasonally unadjusted)") +
    scale_fill_viridis(
      name = paste(report_month,
                   report_year,
                   "\nUnemployment\nRate"),
      direction = -1,
      begin = 0.3,
      end = 1,
      labels = percent_format(accuracy = 1),
      breaks = breaks_pretty(n = 5)
    ) +
    theme_minimal() +
    theme(
      legend.title = element_text(size = 11,
                                  colour = "grey20"),
      legend.text = element_text(size = 10,
                                 colour = "grey20"),
      plot.caption = element_text(
        size = 8,
        colour = "grey60",
        face = "italic",
        hjust = 1.3
      ),
      panel.grid.major = element_line(colour = "transparent"),
      axis.text = element_blank()
    )
```

Row 3
---------------------------------------------------------------------------

### Number of Jobs in B.C. {.value-box}

```{r}
# recent month employment
recent_month_employment_bc <- lfc_province_tidy %>%
  filter(
    vector == "v2064701",
    date == max(date)
  )

valueBox(
  value = recent_month_employment_bc %>%
    pull(value) %>%
    signs(format = comma),
  # icon = "fa-users-cog",
  caption = paste("Number of Jobs in B.C. for", report_month, report_year)
)
```

### Month-Over-Month Change in Number of Jobs in B.C. {.value-box}

```{r}
valueBox(
  value = recent_month_employment_bc %>%
    pull(month_change) %>%
    signs(
      format = comma,
      add_plusses = TRUE
    ),
  # icon = "fa-users-cog",
  caption = "Month-Over-Month Change in Number of Jobs in B.C."
)
```

### Year-Over-Year Change in Number of Jobs in B.C. {.value-box}

```{r}
year_change_employment_bc <- lfc_province_tidy %>%
  filter(
    vector == "v2064701",
    date %in% c(max(date) - months(12), max(date))
  ) %>%
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date))

# year over year change employment
valueBox(
  value = year_change_employment_bc %>%
    pull(year_change) %>%
    signs(
      format = comma,
      add_plusses = TRUE
    ),
  # icon = "fa-users-cog",
  caption = paste("Year-Over-Year Change in Number of Jobs in B.C.")
)
```

Row 4
---------------------------------------------------------------------

### Month-Over-Month Change in Number of Jobs in B.C. for `r report_year` 

```{r, fig.width=7, fig.height=5}
ggplotly_lfs(
  lfc_province_tidy %>%
  filter(
    vector == "v2064701",
    date >= paste0(report_year, "-01-01")
  ) %>%
  {
    ggplot(
      .,
      aes(
        x = date,
        y = month_change,
        text = paste0(
          "Number of Jobs: ",
          signs(
            value,
            format = comma
          ),
          "<br>",
          "Month-Over-Month Change: ",
          signs(
            month_change,
            format = comma,
            add_plusses = TRUE
          ),
          "<br>",
          "% Month-Over-Month Change: ",
          signs(
            month_change_percent,
            format = percent,
            add_plusses = TRUE,
            accuracy = 0.1
          )
        )
      )
    ) +
      geom_col(
        fill = main_colour,
        alpha = 0.6
      ) +
      geom_text(
        aes(
          label = signs(
            month_change,
            format = comma,
            add_plusses = TRUE
          )
        ),
        nudge_y = ifelse(.$month_change > 0, 10000, -10000),
        colour = "grey20",
        size = 2.5
      ) +
      labs(
        x = NULL,
        y = NULL
      ) +
      scale_y_continuous(
        labels = comma,
        breaks = breaks_pretty(n = 8)
      ) +
      scale_x_date(breaks = breaks_pretty(n = 5)) +
      theme_minimal() +
      theme_vert
  }
)
```


### Month-Over-Month Percent Change in Number of Jobs by B.C. Economic Region for `r paste(report_month, report_year)`

```{r, fig.width=7, fig.height=5}
lfc_region_tidy %>%
    filter(
      geo != "British Columbia",
      labour_force_characteristics == "Employment",
      date == max(date)
    ) %>%
    mutate(geo_label = str_wrap(str_extract(geo, "^([^,])+"), width = 10)) %>%
    ggplot() +
    geom_sf(
      aes(
        fill = month_change_percent),
      colour = "white",
      lwd = .2
    ) +
    geom_sf_text(aes(label = geo_label),
                 size = 3.5,
                 colour = "grey20") +
    labs(x = NULL, y = NULL,
         caption = "(3-month-moving-avg, seasonally unadjusted)") +
    scale_fill_viridis(
      name = paste(report_month,
                   report_year,
                   "\n% Change\nin Number\nof Jobs"),
      direction = -1,
      begin = 0.3,
      end = 1,
      labels = percent_format(accuracy = 1),
      breaks = breaks_pretty(n = 3)
    ) +
    theme_minimal() +
    theme(
      legend.title = element_text(size = 11,
                                  colour = "grey20"),
      legend.text = element_text(size = 10,
                                 colour = "grey20"),
      plot.caption = element_text(
        size = 8,
        colour = "grey60",
        face = "italic",
        hjust = 1.3
      ),
      panel.grid.major = element_line(colour = "transparent"),
      axis.text = element_blank()
    )

```


Row 5
-----------------------------------------------------------------------

### CAN Unemployment Rate (%) for Recent Month {.value-box}

```{r}
#recent monthly change in unemployment for CAN
month_unemployment_rate_can <- lfc_province_tidy %>%
  filter(vector == "v2062815",
         date == max(date))

valueBox(
  value = month_unemployment_rate_can %>%
    pull(value) %>%
    signs(format = percent, accuracy = 0.1),
  # icon = "fa-users-cog",
  caption = paste("Canada Unemployment Rate in", report_month)
)
```

### Month-Over-Month Change in Canada Unemployment Rate {.value-box}

```{r}
#recent monthly change in unemployment for CAN
valueBox(
  value = month_unemployment_rate_can %>%
    pull(month_change) %>%
    signs(format = percent, accuracy = 0.1),
  # icon = "fa-users-cog",
  caption = paste("Month-Over-Month Change in Canada Unemployment Rate")
)
```

### Year-Over-Year Change in Canada Unemployment Rate {.value-box}

```{r}
#CAN year over year change unemployment rate
year_change_unemployment_rate_can <- lfc_province_tidy %>%
  filter(vector == "v2062815",
  date %in% c(max(date) - months(12), max(date))) %>% 
  mutate(year_change = value - lag(value)) %>% 
  filter(date == max(date))

valueBox(
  value = year_change_unemployment_rate_can %>%
    pull(year_change) %>%
    signs(
      format = percent,
      add_plusses = TRUE,
      accuracy = 0.1
    ),
  # icon = "fa-users-cog",
  caption = paste("Year-Over-Year Change in Canada Unemployment Rate")
)
```

Row 6
---------------------------------------------------------------------------

### Unemployment Rate for `r paste(report_month, report_year)` by Province

```{r, fig.width=7, fig.height=5, eval=TRUE}
unemploy_rt_provinces <- lfc_province_tidy %>%
  filter(
    labour_force_characteristics == "Unemployment rate",
    sex == "Both sexes",
    age_group == "15 years and over",
    date == max(date),
    geo != "Canada") 

unemploy_rt_provinces_spatial <-  can_provinces %>% 
  left_join(unemploy_rt_provinces, 
            by = c("name"= "geo")) 


# unemploy_rt_provinces_spatial %>% 
#   st_transform(3979) %>%
#   plot_ly(split = ~value, 
#           color = ~value, 
#           text = ~paste0(
#       "Province: ",
#       name,
#       "<br>",
#       "Unemployment Rate: ",
#       signs(value,
#             format = percent)
#     ),
#           hoveron = "fills",
#           hoverinfo = "text",
#           showlegend = FALSE) %>% 
#   colorbar(title = paste(report_month,
#                   report_year,
#                   "\nUnemployment\nRate"))


unemploy_rt_provinces_spatial %>% 
  st_transform(3979) %>% 
  ggplot() +
  geom_sf(aes(fill = value,
              text = paste0(report_month," ",report_year,"\n",
                            name,"\n","Unemployment Rate: ",
                            signs(value,
            format = percent,
            accuracy = 0.1)
    ))) +
   labs(x = NULL, y = NULL) +
  scale_fill_viridis(
    name = paste(report_month,
                 report_year,
                 "\nUnemployment\nRate"),
    direction = -1,
    begin = 0.3,
    end = 1,
    labels = percent_format(accuracy = 1),
    breaks = breaks_pretty(n = 5),
    na.value="white"
  ) +
  theme_minimal() +
  theme(
    legend.title = element_text(size = 11,
                                colour = "grey20"),
    legend.text = element_text(size = 10,
                               colour = "grey20"),
    plot.caption = element_text(
      size = 8,
      colour = "grey60",
      face = "italic",
      hjust = 1.3
    ),
    panel.grid.major = element_line(colour = "transparent"),
    axis.text = element_blank()
  )
```

### Monthly Unemployment Rates by Province for `r report_year`

```{r, fig.width=7, fig.height=5}
prov_acronyms <- tribble(
  ~geo, ~acronym,
  "British Columbia", "BC",
  "Alberta", "Alta",
  "Saskatchewan", "Sask",
  "Newfoundland and Labrador", "NL",
  "Prince Edward Island", "PEI",
  "Nova Scotia", "NS",       
  "New Brunswick", "NB",       
  "Quebec", "Que",               
  "Ontario", "Ont",
  "Manitoba", "Man"
)

unemploy_rt_provinces_report_year <-  lfc_province_tidy %>%
  filter(
    labour_force_characteristics == "Unemployment rate",
    sex == "Both sexes",
    age_group == "15 years and over",
    geo != "Canada",
    date >= paste0(report_year, "-01-01")
) %>% 
 mutate(fill_col = ifelse(geo == "British Columbia", "bc", "other")) %>% 
  left_join(prov_acronyms)

p <- unemploy_rt_provinces_report_year %>% 
 ggplot(aes(
    x = date,
    y = value,
    group = geo
  )) +
  geom_point(aes(colour = fill_col,
                 text = paste0(
      "Province: ",
      geo,
      "<br>",
      "Date: ",
      date,
      "<br>",
      "Unemployment Rate: ",
      signs(value,
            format = percent)
    )),
    alpha = 0.6) +
  geom_line(alpha = 0.8, colour = main_colour) +
  geom_line(data = unemploy_rt_provinces_report_year %>% filter(acronym == "BC"), 
            alpha = 0.8, size = 1, colour = "#440154FF") +
  geom_text(data = unemploy_rt_provinces_report_year %>% filter(date == max(date)),
            aes(label = acronym,
                x = date,
                y = value,
                colour = fill_col),
                nudge_x = 8
            ) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = percent,
                     breaks = breaks_pretty(n = 6)) +
  scale_colour_manual(guide = FALSE,
                      values = c(bc = "#440154FF",
                               other = main_colour)) +
  scale_x_date(breaks = breaks_pretty(n = 5)) +
  scale_size(range= c(6, 1)) +
  theme_minimal() +
  theme_vert +
  theme(legend.position = "none")

ggplotly_lfs(p)
```


```{r, include=FALSE}
### Number of Jobs in Canada in August {.value-box}

#recent monthly change in CAN employment
month_change_employment_can <- lfc_province_tidy %>%
  filter(vector == "v2062811",
         date == max(date))

valueBox(
  value = month_change_employment_can %>%
    pull(value) %>%
    signs(format = comma),
  # icon = "fa-users-cog",
  caption = paste("Number of Jobs in Canada in", report_month)
)
```


```{r, include=FALSE}
### Month-Over-Month Change in Number of Jobs in Canada {.value-box}

#recent monthly change in CAN employment
valueBox(
  value = month_change_employment_can %>%
    pull(month_change) %>%
    signs(format = comma,
          add_plusses = TRUE),
  # icon = "fa-users-cog",
  caption = "Month-Over-Month Change in Number of Jobs in Canada"
)
```


```{r, include=FALSE}
### Year-Over-Year Change in Number of Jobs in Canada {.value-box}

year_change_employment_can <- lfc_province_tidy %>%
  filter(vector == "v2062811",
         date %in% c(max(date) - months(12), max(date))) %>% 
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>% 
  filter(date == max(date))

#year over year change employment
valueBox(value = year_change_employment_can %>% 
  pull(year_change) %>%
  signs(format = comma,
        add_plusses = TRUE),
         # icon = "fa-users-cog",
         caption = paste("Year-Over-Year Change in Number of Jobs in Canada"))
```

Demographics
=========================================================================

Row 1
----------------------------------------------------------------------------

### Women B.C. Unemployment Rate (Aged 25 Years & Over) {.value-box}

```{r}
#bc unemployment rate - females
recent_month_unemployment_rate_bc_female <- lfc_province_tidy %>%
  filter(vector == "v2064831",
         date == max(date))

valueBox(paste0("Women: ",
  value = recent_month_unemployment_rate_bc_female %>%
    pull(value) %>%
    signs(format = percent, accuracy = 0.1)),
  # icon = "fa-users-cog",
  caption = paste("B.C. Unemployment Rate for Women for", report_month, report_year, " (Ages 25 Years & Over)")
)
```


### Men B.C. Unemployment Rate (Aged 25 Years & Over) {.value-box}

```{r}
#unemployment rate - males
recent_month_unemployment_rate_bc_male <- lfc_province_tidy %>%
  filter(vector == "v2064822",
         date == max(date))

valueBox(
  value = paste0("Men: ",
                 recent_month_unemployment_rate_bc_male %>%
    pull(value) %>%
    signs(format = percent, accuracy = 0.1)),
  # icon = "fa-users-cog",
  caption = paste("B.C. Unemployment Rate for Men for", report_month, report_year, " (Ages 25 Years & Over)")
)
```

Row 2 {data-height=250}
----------------------------------------------------------------
```{r}
gt_lfs <- function(tbl) {
  tbl %>% 
  ungroup() %>%
  select(value, labour_force_characteristics, month_change, year_change) %>%
  pivot_longer(cols = c(-labour_force_characteristics)) %>%
  mutate(name_label = case_when(
    name == "value" ~ toTitleCase(labour_force_characteristics),
    name == "month_change" ~ "Month-Over-Month Change",
    name == "year_change" ~ "Year-Over-Year Change",
    TRUE ~ "there is a problem"
  ), .after = name) %>% 
  gt() %>%
  tab_style(
    style = cell_text(
      size = px(13),
      color = "#999",
      transform = "uppercase"
    ), locations = cells_column_labels(everything())
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      rows = name == "value")
  ) %>% 
  cols_label(
    value = report_prov_date,
    name_label = ""
  ) %>%
  cols_hide(
    columns = vars(name, labour_force_characteristics)
  ) %>% 
  cols_width(
    vars(value) ~ px(350)
  )
}
```

### Change in Recent B.C. Unemployment Rate for Women

```{r}
##year over year change unemployment rate female
year_change_unemployment_bc_female <- lfc_province_tidy %>%
  filter(vector %in% c("v2064831"),
         date %in% c(max(date) - months(12), max(date))
  ) %>%
  mutate(year_change = value - lag(value)) %>%
  filter(date == max(date))

year_change_unemployment_bc_female %>%
  gt_lfs() %>% 
  fmt_percent("value", decimals = 1) %>% 
  text_transform(
    locations = cells_body(
      columns = "value",
      rows = name != "value"
    ),
    fn = function(x) ifelse(x > 0, paste(x, up_arrow), paste(x, down_arrow))
  ) 
```

### Change in Recent B.C. Unemployment Rate for Men

```{r}
##year over year change unemployment rate bc males
year_change_unemployment_bc_male <- lfc_province_tidy %>%
  filter(vector %in% c("v2064822"),
         date %in% c(max(date) - months(12), max(date))
  ) %>%
  mutate(year_change = value - lag(value)) %>%
  filter(date == max(date))


year_change_unemployment_bc_male %>% 
  gt_lfs() %>% 
  fmt_percent("value", decimals = 1) %>% 
  text_transform(
    locations = cells_body(
      columns = "value",
      rows = name != "value"
    ),
    fn = function(x) ifelse(x > 0, paste(x, up_arrow), paste(x, down_arrow))
  )
```

Row 3
-----------------------------------------------------------------------

### Monthly B.C. Unemployment Rates by Gender Since 2000 (Ages 25 Years & Over)

```{r, fig.width=7, fig.height=5}
ggplotly_lfs(
lfc_province_tidy %>%
  filter(
    date > "1999-12-01",
    geo == "British Columbia",
    labour_force_characteristics %in% c("Unemployment rate"),
    age_group %in% c("25 years and over"
                     # "15 to 24 years",
                     # "25 to 54 years",
                     # "55 years and over"
                     ),
    sex != "Both sexes"
  ) %>% 
  mutate(highlight = case_when(date >= paste0(report_year, "-01-01") ~ "thisyear",
                               TRUE ~ "preyears")) %>% 
  ggplot(aes(
    x = date,
    y = value,
    colour = highlight
  )) +
  geom_point(aes(text = paste0(
      "Date: ",
      date,
      "<br>",
      "Age Group: ",
      age_group,
      "<br>",
      "Unemployment Rate: ",
      signs(value,
            format = percent,
            accuracy = 0.1)
    )),
    alpha = 0.6) +
  geom_line(alpha = 0.8) +
  facet_wrap(facets = vars(sex),
             labeller = as_labeller(gender_labels)) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = percent,
                     breaks = breaks_pretty(n = 6)) +
  scale_colour_manual(guide = FALSE,
                  values = c(preyears = "grey50",
                               thisyear = main_colour)) +
  scale_x_date(breaks = breaks_pretty(n = 5)) +
  theme_minimal() +
  theme_facet +
  theme(legend.position = "none")
)
```

Row 4
-------------------------------------------------------------------

### Women Number of Jobs  in B.C. (Aged 25 Years & Over) {.value-box}

```{r}
year_change_employment_bc_female <- lfc_province_tidy %>%
  filter(
    vector == "v2064827",
    date %in% c(max(date) - months(12), max(date))
  ) %>%
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date))


recent_month_employment_bc_female <- lfc_province_tidy %>%
  filter(
    vector == "v2064827",
    date == max(date)) 

valueBox(
  value = paste0("Women: ",
                 year_change_employment_bc_female %>%
    pull(year_change) %>%
    signs(format = comma,
          add_plusses = TRUE)),
  # icon = "fa-users-cog",
  caption = paste("Year-Over-Year Change in Jobs for Women in B.C. for", report_month, report_year, "(Ages 25 Years & Over)")
)
```

### Men Number of Jobs for (Aged 25 Years & Over) in B.C. {.value-box}}

```{r}
#recent month employment males
recent_month_employment_bc_male <- lfc_province_tidy %>%
  filter(vector == "v2064818",
    date == max(date))

year_change_employment_bc_male <- lfc_province_tidy %>%
  filter(
    vector == "v2064818",
    date %in% c(max(date) - months(12), max(date))
  ) %>%
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date))

valueBox(
  value = paste0("Men: ",
                 year_change_employment_bc_male %>%
    pull(year_change) %>%
    signs(format = comma,
          add_plusses = TRUE)),
  # icon = "fa-users-cog",
  caption = paste("Year-Over-Year Change in Jobs for Men in B.C. for", report_month, report_year, "(Ages 25 Years & Over)")
)
```

Row 5 {data-height=250}
----------------------------------------------------------------------

### Change in Number of Jobs for Women in B.C.

```{r}
year_change_employment_bc_female %>% 
  gt_lfs() %>% 
  fmt_number("value", decimals = 0) %>% 
  text_transform(
    locations = cells_body(
      columns = "value",
      rows = name != "value"
    ),
    fn = function(x) ifelse(x > 0, paste(x, up_arrow), paste(x, down_arrow))
  ) 
```

### Change in Number of Jobs for Men in B.C. 

```{r}
year_change_employment_bc_male %>% 
  gt_lfs() %>% 
  fmt_number("value", decimals = 0) %>% 
  text_transform(
    locations = cells_body(
      columns = "value",
      rows = name != "value"
    ),
    fn = function(x) ifelse(x > 0, paste(x, up_arrow), paste(x, down_arrow))
  ) 
```

Row 6
----------------------------------------------------------------------------

### Month-Over-Month Change in Number of Jobs in B.C. by Gender for `r report_year` (Ages 25 Years & Over)

```{r, fig.width=7, fig.height=5}
ggplotly_lfs(
  lfc_province_tidy %>%
  filter(
    date >= paste0(report_year, "-01-01"),
    geo == "British Columbia",
    labour_force_characteristics == "Employment",
    age_group == "25 years and over",
    sex != "Both sexes"
  ) %>% 
    {
  ggplot(data = .,
         aes(
    x = date,
    y = month_change,
    text = paste0(
      "Number of Jobs: ",
      signs(value,
            format = comma),
      "<br>",
      "Month-Over-Month Change: ",
      signs(month_change,
            format = comma,
            add_plusses = TRUE),
      "<br>",
      "% Month-Over-Month Change: ",
      signs(
        month_change_percent,
        format = percent,
        add_plusses = TRUE,
        accuracy = 0.1
      )
    )
         )) +
  geom_col(fill = main_colour,
           alpha = 0.6) +
  facet_wrap(~sex,
             labeller = as_labeller(gender_labels)) +
  geom_text(
    aes(
      label = signs(
        month_change,
        format = comma,
        add_plusses = TRUE
      )
    ),
    nudge_y = ifelse(.$month_change > 0, 3000, -3000),
    colour = "grey20",
    size = 2
  ) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = comma,
                     breaks = breaks_pretty(8)) +
  scale_x_date(breaks = breaks_pretty(n = 5)) +
  theme_minimal() +
  theme_facet
# theme(strip.text.y = element_text(angle = 0))
  }
)
```

Row 7
-----------------------------------------------------------------------------

### Youth B.C. Unemployment Rate (Ages 15 to 25 Years) {.value-box}

```{r}
#monthly unemployment rate - youth
valueBox(
  value = paste0("Youth: ",
                 lfc_province_tidy %>%
  filter(vector == "v2064732",
         date == max(date)) %>%
    pull(value) %>%
    signs(format = percent, accuracy = 0.1)),
  # icon = "fa-users-cog",
  caption = paste("B.C. Unemployment Rate for Youth (15 to 24 Years) for", report_month, report_year)
)
```

### Month-Over-Month Change in Number of Jobs for Youth in B.C. (Ages 15 to 24 Years) {.value-box}

```{r}
valueBox(
  value = lfc_province_tidy %>%
  filter(vector == "v2064728",
         date == max(date)) %>%
    pull(month_change) %>%
    signs(format = comma,
            add_plusses = TRUE),
  # icon = "fa-users-cog",
  caption = "Month-Over-Month Change in Number of Jobs for Youth in B.C."
)
```

### Year-Over-Year Change in Number of Jobs for Youth in B.C. (Ages 15 to 24 Years) {.value-box}

```{r}
year_change_employment_bc_youth <- lfc_province_tidy %>%
  filter(
    vector == "v2064728",
    date %in% c(max(date) - months(12), max(date))
  ) %>%
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date))

# year over year change employment
valueBox(
  value = year_change_employment_bc_youth %>%
    pull(year_change) %>%
    signs(
      format = comma,
      add_plusses = TRUE
    ),
  # icon = "fa-users-cog",
  caption = paste("Year-Over-Year Change in Number of Jobs for Youth in B.C.")
)
```

Row 8
-----------------------------------------------------------------------------

### Monthly B.C. Unemployment Rates by Age & Gender for `r report_year`

```{r, fig.width=7, fig.height=5}
ggplotly_lfs(
lfc_province_tidy %>%
  filter(
    date > "2019-12-01",
    geo == "British Columbia",
    labour_force_characteristics %in% c("Unemployment rate"),
    age_group %in% c(
                     "15 to 24 years",
                     "25 to 54 years",
                     "55 years and over"
                     ),
    sex != "Both sexes"
  ) %>% 
  ggplot(aes(
    x = date,
    y = value,
    colour = age_group
  )) +
  geom_point(aes(text = paste0(
      "Date: ",
      date,
      "<br>",
      "Gender: ",
      sex,
      "<br>",
      "Age Group: ",
      age_group,
      "<br>",
      "Unemployment Rate: ",
      signs(value,
            format = percent,
            accuracy = 0.1)
    )),
    alpha = 0.6) +
  geom_line(alpha = 0.8) +
  facet_wrap(facets = vars(sex),
             labeller = as_labeller(gender_labels)) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = percent,
                     breaks = breaks_pretty(n = 6)) +
  scale_colour_viridis_d(name = NULL) +
  scale_x_date(breaks = breaks_pretty(n = 4)) +
  theme_minimal() +
  theme_facet
) %>%
  layout(legend = list(
    orientation = "h",
    x = 0.5,
    y = -0.2,
    xanchor = "center"
  ))
```

### Month-Over-Month Change in Number of Jobs in B.C. for Youth by Gender in `r report_year` (Ages 15 to 24 Years)

```{r, fig.width=7, fig.height=5}

##labels
gender_labels_youth <-  c("Males" = "Youth: Men",
                          "Females" = "Youth: Women")
ggplotly_lfs(
  lfc_province_tidy %>%
  filter(
    date >= paste0(report_year, "-01-01"),
    geo == "British Columbia",
    labour_force_characteristics == "Employment",
    age_group == "15 to 24 years",
    sex != "Both sexes"
  ) %>%
    {
  ggplot(data = .,
         aes(
    x = date,
    y = month_change,
   text = paste0(
      "Number of Jobs: ",
      signs(value,
            format = comma),
      "<br>",
      "Month-Over-Month Change: ",
      signs(month_change,
            format = comma,
            add_plusses = TRUE),
      "<br>",
      "% Month-Over-Month Change: ",
      signs(
        month_change_percent,
        format = percent,
        add_plusses = TRUE,
        accuracy = 0.1
      )
    )
  )) +
  geom_col(fill = main_colour,
           alpha = 0.6) +
  facet_wrap(facets = vars(sex),
             labeller = as_labeller(gender_labels_youth)) +
  geom_text(
    aes(
      label = signs(
        month_change,
        format = comma,
        add_plusses = TRUE
      )
    ),
    nudge_y = ifelse(.$month_change > 0, 1500, -1500),
    colour = "grey20",
    size = 2
  ) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = comma,
                     breaks = breaks_pretty(5)) +
  scale_x_date(breaks = breaks_pretty(n = 4)) +
  theme_minimal() +
  theme_facet
}
)
```

Job Type
===================================================================

Row 1
------------------------------------------------------------------

### Number of Full-time Jobs in B.C. {.value-box}

```{r}
year_change_employment_bc_ft <- lfc_province_tidy %>%
  filter(
    vector == "v2064702",
    date %in% c(max(date) - months(12), max(date))
  ) %>%
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date))

valueBox(
  value = paste0("Full-time: ",
                 year_change_employment_bc_ft %>% 
    pull(year_change) %>%
    signs(format = comma,
          add_plusses = TRUE)),
  # icon = "fa-users-cog",
  caption = paste("Year-Over-Year Change in Number of Full-time Jobs in B.C. for", report_month, report_year)
)
```

### Number of Part-Time Jobs in B.C. {.value-box}

```{r}
year_change_employment_bc_pt <- lfc_province_tidy %>%
  filter(
    vector == "v2064703",
    date %in% c(max(date) - months(12), max(date))
  ) %>%
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date))

valueBox(
  value = paste0("Part-time: ",
                 year_change_employment_bc_pt %>% 
    pull(year_change) %>%
    signs(format = comma,
          add_plusses = TRUE)),
  # icon = "fa-users-cog",
  caption = paste("Year-Over-Year Change in Number of Part-time Jobs in B.C. for", report_month, report_year)
)
```

Row 2 {data-height=270}
------------------------------------------------------------------

### Change in Number of Full-time Jobs in B.C. 
```{r}
year_change_employment_bc_ft %>% 
  gt_lfs() %>% 
  fmt_number("value", decimals = 0) %>% 
  text_transform(
    locations = cells_body(
      columns = "value",
      rows = name != "value"
    ),
    fn = function(x) ifelse(x > 0, paste(x, up_arrow), paste(x, down_arrow))
  ) 
```
 
### Change in Number of Part-Time Jobs in B.C.

```{r}
year_change_employment_bc_pt %>% 
  gt_lfs() %>% 
  fmt_number("value", decimals = 0) %>% 
  text_transform(
    locations = cells_body(
      columns = "value",
      rows = name != "value"
    ),
    fn = function(x) ifelse(x > 0, paste(x, up_arrow), paste(x, down_arrow))
  ) 
```

Row 3
---------------------------------------------------------------------

### Month-Over-Month Change in Number of Jobs in B.C. by Job Type in `r report_year` 

```{r, fig.width=7, fig.height=5}
ggplotly_lfs(
  lfc_province_tidy %>%
  filter(
    date >= paste0(report_year, "-01-01"),
    geo == "British Columbia",
    labour_force_characteristics %in% c("Full-time employment",
                                        "Part-time employment"),
    sex == "Both sexes",
    age_group == "15 years and over"
  ) %>%
  mutate(labour_force_characteristics = str_extract(
    labour_force_characteristics,
    "^([^,])+ "
  ), sep_out = "-") %>% {
    ggplot(data = ., 
         aes(
    x = date,
    y = month_change,
    text = paste0(
    "Number of Jobs: ",
          signs(
            value,
            format = comma
          ),
          "<br>",
          "Month-Over-Month Change: ",
          signs(
            month_change,
            format = comma,
            add_plusses = TRUE
          ),
          "<br>",
          "% Month-Over-Month Change: ",
          signs(
            month_change_percent,
            format = percent,
            add_plusses = TRUE,
            accuracy = 0.1
      )
    )
  )) +
  geom_col(fill = main_colour,
           alpha = 0.6) +
  facet_wrap(
    facets = vars(labour_force_characteristics),
    ncol = 2
    # labeller = labeller(labour_force_characteristics = label_wrap_gen(width = 10))
  ) +
  geom_text(
    aes(
      label = signs(
        month_change,
        format = comma,
        add_plusses = TRUE
      )
    ),
    nudge_y = ifelse(.$month_change > 0, 8000, -8000),
    colour = "grey20",
    size = 2.5
  ) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = comma,
                     breaks = breaks_pretty(n = 8)) +
  scale_x_date(breaks = breaks_pretty(n = 5)) +
  theme_minimal() +
  theme_facet +
  theme(panel.spacing = unit(1, "lines"))
})
```

Row 4
------------------------------------------------------------------------------

### Women Full-time Year-Over-Year Change in Number of Jobs in B.C. {.value-box}

```{r}
year_change_employment_bc_female_ft <- lfc_province_tidy %>%
  filter(
    date %in% c(max(date) - months(12), max(date)),
    geo == "British Columbia",
    labour_force_characteristics == "Full-time employment",
    sex == "Females",
   age_group == "15 years and over"
  ) %>%
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date))


# year over year change employment
valueBox(
  value = paste0("Women F/T: ",
                 year_change_employment_bc_female_ft %>%
    pull(year_change) %>%
    signs(
      format = comma,
      add_plusses = TRUE
    )),
  # icon = "fa-users-cog",
  caption = paste("Year-Over-Year Change in Number of Full-time Jobs for Women (15 Years and Over) in B.C.")
)
```

### Women Part-time Year-Over-Year Change in Number of Jobs in B.C. {.value-box}

```{r}
year_change_employment_bc_female_pt <- lfc_province_tidy %>%
  filter(
    date %in% c(max(date) - months(12), max(date)),
    geo == "British Columbia",
    labour_force_characteristics == "Part-time employment",
    sex == "Females",
   age_group == "15 years and over"
  ) %>%
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date))


# year over year change employment
valueBox(
  value = paste0("Women P/T: ",
                 year_change_employment_bc_female_pt %>%
    pull(year_change) %>%
    signs(
      format = comma,
      add_plusses = TRUE
    )),
  # icon = "fa-users-cog",
  caption = paste("Year-Over-Year Change in Number of Part-time Jobs for Women (15 Years and Over) in B.C.")
)
```

Row 5
------------------------------------------------------------------------------

### Month-Over-Month Change in Number of Jobs for Women in B.C. by Job Type & Age for `r report_year`

```{r}
ggplotly_lfs(
lfc_province_tidy %>%
  filter(
    date >= paste0(report_year, "-01-01"),
    geo == "British Columbia",
    labour_force_characteristics %in% c("Full-time employment",
                                        "Part-time employment"),
    sex == "Females",
   age_group %in% c(
                     "15 to 24 years",
                     "25 years and over"
                     )
  ) %>%
  mutate(labour_force_characteristics = str_extract(
    labour_force_characteristics,
    "^([^,])+ "
  ), sep_out = "-") %>% 
  ggplot(data = .,
         aes(x = date, 
             y = month_change,
              text = paste0(
                "Job Type: ",
                labour_force_characteristics,
                "<br>",
    "Number of Jobs: ",
          signs(
            value,
            format = comma
          ),
          "<br>",
          "Month-Over-Month Change: ",
          signs(
            month_change,
            format = comma,
            add_plusses = TRUE
          ),
          "<br>",
          "% Month-Over-Month Change: ",
          signs(
            month_change_percent,
            format = percent,
            add_plusses = TRUE,
            accuracy = 0.1
      )
    ))) +
  geom_col(aes(fill = labour_force_characteristics),
           alpha = 0.6) +
facet_grid(. ~ age_group) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = comma,
                     breaks = breaks_pretty(n = 8)) +
  scale_x_date(breaks = breaks_pretty(n = 5)) +
   scale_fill_viridis_d(name = NULL) +
  theme_minimal() +
  theme_facet +
  theme(panel.spacing = unit(1, "lines"))
) %>%
  layout(legend = list(
    orientation = "h",
    x = 0.5,
    y = -0.2,
    xanchor = "center"
  ))
```

Row 6
------------------------------------------------------------------------------

### Men Full-time Year-Over-Year Change in Number of Jobs (15 Years and Over) in B.C. {.value-box}

```{r}
year_change_employment_bc_male_ft <- lfc_province_tidy %>%
  filter(
    date %in% c(max(date) - months(12), max(date)),
    geo == "British Columbia",
    labour_force_characteristics == "Full-time employment",
    sex == "Males",
   age_group == "15 years and over"
  ) %>%
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date))


# year over year change employment
valueBox(
  value = paste0("Men F/T: ",
                 year_change_employment_bc_male_ft %>%
    pull(year_change) %>%
    signs(
      format = comma,
      add_plusses = TRUE
    )),
  # icon = "fa-users-cog",
  caption = paste("Year-Over-Year Change in Number of Full-time Jobs for Men (15 Years and Over) in B.C.")
)
```

### Men Part-time Year-Over-Year Change in Number of Jobs (15 Years and Over) in B.C. {.value-box}

```{r}
year_change_employment_bc_male_pt <- lfc_province_tidy %>%
  filter(
    date %in% c(max(date) - months(12), max(date)),
    geo == "British Columbia",
    labour_force_characteristics == "Part-time employment",
    sex == "Males",
   age_group == "15 years and over"
  ) %>%
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date))


# year over year change employment
valueBox(
  value = paste0("Men P/T: ",
                 year_change_employment_bc_male_pt %>%
    pull(year_change) %>%
    signs(
      format = comma,
      add_plusses = TRUE
    )),
  # icon = "fa-users-cog",
  caption = paste("Year-Over-Year Change in Number of Part-time Jobs for Men (15 Years and Over) in B.C.")
)
```

Row 7
------------------------------------------------------------------------------

### Month-Over-Month Change Change in Number of Jobs for Men in B.C. by Job Type & Age for `r report_year`

```{r}
ggplotly_lfs(
lfc_province_tidy %>%
  filter(
    date >= paste0(report_year, "-01-01"),
    geo == "British Columbia",
    labour_force_characteristics %in% c("Full-time employment",
                                        "Part-time employment"),
    sex == "Males",
   age_group %in% c(
                     "15 to 24 years",
                     "25 years and over"
                     )
  ) %>%
  mutate(labour_force_characteristics = str_extract(
    labour_force_characteristics,
    "^([^,])+ "
  ), sep_out = "-") %>% 
  ggplot(data = .,
         aes(x = date, 
             y = month_change,
              text = paste0(
                "Job Type: ",
                labour_force_characteristics,
                "<br>",
    "Number of Jobs: ",
          signs(
            value,
            format = comma
          ),
          "<br>",
          "Month-Over-Month Change: ",
          signs(
            month_change,
            format = comma,
            add_plusses = TRUE
          ),
          "<br>",
          "% Month-Over-Month Change: ",
          signs(
            month_change_percent,
            format = percent,
            add_plusses = TRUE,
            accuracy = 0.1
      )
    ))) +
  geom_col(aes(fill = labour_force_characteristics),
           alpha = 0.6) +
facet_grid(. ~ age_group) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = comma,
                     breaks = breaks_pretty(n = 8)) +
  scale_x_date(breaks = breaks_pretty(n = 5)) +
   scale_fill_viridis_d(name = NULL) +
  theme_minimal() +
  theme_facet +
  theme(panel.spacing = unit(1, "lines"))
) %>%
  layout(legend = list(
    orientation = "h",
    x = 0.5,
    y = -0.2,
    xanchor = "center"
  ))
```

Industry
====================================================================

Row 1
------------------------------------------------------------------

### Public Sector Month-Over-Month Change in Number of Jobs in B.C. {.value-box}

```{r}
month_employment_bc_jobtype <- employment_by_class_tidy %>%
  filter(
    class_of_worker %in% c(
      "Public sector employees",
      "Private sector employees",
      "Self-employed"
    ),
   date == max(date)
  ) %>%
  mutate(class_of_worker = recode(class_of_worker,
                                  "Public sector employees" = "Public Sector",
                                  "Private sector employees" = "Private Sector",
                                  "Self-employed" = "Self-employed"))

year_employment_bc_jobtype <- employment_by_class_tidy %>%
  filter(
    class_of_worker %in% c(
      "Public sector employees",
      "Private sector employees",
      "Self-employed"
    ),
    date %in% c(max(date) - months(12), max(date))
  ) %>%
  group_by(vector) %>%
  mutate(
    class_of_worker = recode(
      class_of_worker,
      "Public sector employees" = "Public Sector",
      "Private sector employees" = "Private Sector",
      "Self-employed" = "Self-employed"
    ),
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date))

valueBox(
  value = paste0("Public: ",
                 year_employment_bc_jobtype %>%
                   filter(class_of_worker == "Public Sector") %>% 
    pull(year_change) %>%
    signs(format = comma,
          add_plusses = TRUE)),
  caption = paste("Year-Over-Year Change in Number of Public Sector Jobs in B.C. for", report_month, report_year)
)
```

### Private Sector Month-Over-Month Change in Number of Jobs in B.C. {.value-box}

```{r}
valueBox(
  value = paste0("Private: ",
                 year_employment_bc_jobtype %>%
                   filter(class_of_worker == "Private Sector") %>% 
    pull(year_change) %>%
    signs(format = comma,
          add_plusses = TRUE)),
  caption = paste("Year-Over-Year Change in Number of Private Sector Jobs in B.C. for", report_month, report_year)
)
```

```{r, include=FALSE}
### Self-employed Month-Over-Month Change in Number of Jobs in B.C. {.value-box}

valueBox(
  value = paste0("Self-employed: ",
                 year_employment_bc_jobtype %>%
                   filter(class_of_worker == "Self-employed") %>% 
    pull(year_change) %>%
    signs(format = comma,
          add_plusses = TRUE)),
  caption = paste("Year-Over-Year Change in Number of Self-employed Jobs in B.C. for", report_month, report_year)
)
```

Row 2 {data-height=240}
-----------------------------------------------------------------------------

### Change in Number of Jobs in B.C. for `r paste(report_month, report_year)`

```{r}
year_employment_bc_jobtype %>% 
  ungroup() %>%
  select(value, class_of_worker, month_change, year_change) %>%
  pivot_longer(cols = c(-class_of_worker)) %>%
  mutate(name_label = case_when(
    name == "value" ~ "Number of Jobs",
    name == "month_change" ~ "Month-Over-Month Change",
    name == "year_change" ~ "Year-Over-Year Change",
    TRUE ~ "there is a problem"
  ), .after = name) %>% 
  pivot_wider(names_from = class_of_worker, values_from = value) %>% 
  gt() %>%
  fmt_number(unique(year_employment_bc_jobtype$class_of_worker), decimals = 0) %>% 
  text_transform(
    locations = cells_body(
      columns = unique(year_employment_bc_jobtype$class_of_worker),
      rows = name %in% c("month_change", "year_change")
    ),
    fn = function(x) ifelse(x > 0, paste(x, up_arrow), paste(x, down_arrow))
  ) %>%
  tab_style(
    style = cell_text(
      size = px(13),
      color = "#999",
      transform = "uppercase"
    ), locations = cells_column_labels(everything())
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      rows = name == "value")
  ) %>% 
  cols_label(
    name_label = ""
  ) %>%
  cols_hide(
    columns = vars(name)
  ) %>% 
  cols_width(everything() ~ px(250))
```

Row 3
----------------------------------------------------------------

### Number of Jobs in B.C. by Month & Sector for `r report_year` 

```{r, fig.width=7, fig.height=5}
ggplotly_lfs(
  employment_by_class_tidy %>%
  filter(
    class_of_worker %in% c(
      "Public sector employees",
      "Private sector employees",
      "Self-employed"),
    date >= paste0(report_year, "-01-01")
  ) %>%
  mutate(class_of_worker = recode(class_of_worker,
                                  "Public sector employees" = "Public Sector",
                                  "Private sector employees" = "Private Sector")) %>% 
  ggplot(data = .,
         aes(
    x = date,
    y = value,
    fill = class_of_worker,
    text = paste0(
      "Class of Worker: ",
      class_of_worker,
      "<br>",
  "Number of Jobs:",
          signs(
            value,
            format = comma
          ),
          "<br>",
          "Month-Over-Month Change:",
          signs(
            month_change,
            format = comma,
            add_plusses = TRUE
          ),
          "<br>",
          "% Month-Over-Month Change:",
          signs(
            month_change_percent,
            format = percent,
            add_plusses = TRUE,
            accuracy = 0.1
      )
    ))) +
  geom_col(alpha = 0.6, position = "dodge2") +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(expand = c(0, 0),
                     labels = comma,
                     breaks = breaks_pretty(n = 6)) +
  scale_x_date(breaks = breaks_pretty(n = 5)) +
  scale_fill_viridis_d(name = NULL) +
  theme_minimal() +
  theme_vert +
    theme(legend.text = element_text(size = 12)) 
) %>%
  layout(legend = list(
    orientation = "h",
    x = 0.5,
    y = -0.2,
    xanchor = "center"
  ))
```

### Month-Over-Month Change in Number of Goods & Services-producing Jobs in B.C. for `r report_year` 

```{r, fig.width=7, fig.height=5}
ggplotly_lfs(
  employment_by_industry_tidy %>%
  filter(
    vector %in% c(
      "v2057794",
      "v2057800"),
    date >= paste0(report_year, "-01-01"))  %>% 
      mutate(naics = recode(naics,
                             "Goods-producing sector" = "Goods-producing Jobs",
                             "Services-producing sector" = "Services-producing Jobs")) %>% 
  ggplot(data = .,
         aes(
    x = date,
    y = month_change,
    text = paste0(
      "Sector: ",
      naics,
      "<br>",
          "Month-Over-Month Change: ",
          signs(
            month_change,
            format = comma,
            add_plusses = TRUE
          ),
          "<br>",
          "% Month-Over-Month Change: ",
          signs(
            month_change_percent,
            format = percent,
            add_plusses = TRUE,
            accuracy = 0.1
      )
    ))) +
  geom_col(aes(fill = naics), alpha = 0.6) +
  labs(x = NULL,
       y = NULL) +
  scale_y_continuous(labels = comma,
                     breaks = breaks_pretty(n = 6)) +
  scale_x_date(breaks = breaks_pretty(n = 5)) +
  scale_fill_viridis_d(name = NULL) +
  theme_minimal() +
  theme_vert
  )  %>%
  layout(legend = list(
    orientation = "h",
    x = 0.5,
    y = -0.2,
    xanchor = "center"
  ))
```

Row 4
---------------------------------------------------------------------------

### Goods-Producing Sector Year-Over-Year Change in Number of Jobs in B.C. {.value-box}

```{r}
year_change_employment_industry_gp <- employment_by_industry_tidy %>%
  filter(
    vector == "v2057794",
    date %in% c(max(date) - months(12), max(date))
  ) %>%
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date))

# year over year change 
valueBox(
  value = paste0("Goods: ",
                 year_change_employment_industry_gp %>%
    pull(year_change) %>%
    signs(
      format = comma,
      add_plusses = TRUE
    )),
  # icon = "fa-users-cog",
  caption = "Year-Over-Year Change in Number of of Goods-producing Jobs in B.C."
)
```

### Services-Producing Sector Year-Over-Year Change in Number of Jobs in B.C. {.value-box}

```{r}
year_change_employment_industry_sp <- employment_by_industry_tidy %>%
  filter(
    vector == "v2057800",
    date %in% c(max(date) - months(12), max(date))
  ) %>%
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date))

# year over year change 
valueBox(
  value = paste0("Services: ",
                 year_change_employment_industry_sp %>%
    pull(year_change) %>%
    signs(
      format = comma,
      add_plusses = TRUE
    )),
  # icon = "fa-users-cog",
  caption = "Year-Over-Year Change in Number of of Services-producing Jobs in B.C."
)
```

Row 5
-----------------------------------------------------------------------

###  Changes in Number of Jobs in B.C. by Industry for `r paste(report_month, report_year)`

```{r, fig.width=12, fig.height=7}
industries <- c("Agriculture [111-112, 1100, 1151-1152]",
                "Forestry, fishing, mining, quarrying, oil and gas [21, 113-114, 1153, 2100]",
                "Utilities [22]",
                "Construction [23]",
                "Manufacturing [31-33]",
                "Wholesale and retail trade [41, 44-45]",
                "Transportation and warehousing [48-49]",
                "Finance, insurance, real estate, rental and leasing [52-53]",
                "Professional, scientific and technical services [54]",
                "Business, building and other support services [55-56]",
                "Educational services [61]",
                "Health care and social assistance [62]",
                "Information, culture and recreation [51, 71]",
                "Accommodation and food services [72]",
                "Other services (except public administration) [81]",
                "Public administration [91]")    

industry_change <- employment_by_industry_tidy %>% 
  filter(naics %in% industries,
         date %in% c(max(date) - months(12), max(date))
  ) %>%
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date)) %>% 
  mutate(industry = str_extract(naics, "^[^\\[]+")) %>%
  ungroup() %>% 
  select(industry, value, month_change,
         month_change_percent, year_change_percent) 

p1 <- ggplot(industry_change) +
  geom_col(aes(value, reorder(industry, -year_change_percent)),
           fill = main_colour, alpha = 0.6) +
  geom_text(aes(value,
                industry,
                label = signs(
        value,
        format = comma
      )),
     nudge_x = 80000,
    colour = "grey20",
    size = 3) +
  labs(x = NULL,
       y = NULL,
        title = "Number of Jobs") +
   scale_x_continuous(expand = expansion(mult = c(0, .3))) +
  theme_minimal() +
  theme_horiz +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size = 11),
        plot.title = element_text(size = 11, colour = "grey20"))

p2 <- ggplot(industry_change, 
         aes(month_change, reorder(industry, -year_change_percent))) +
  geom_col(fill = main_colour, alpha = 0.6) +
  geom_text(aes(label = signs(
        month_change,
        format = comma,
        add_plusses = TRUE
      )),
     nudge_x = ifelse(industry_change$month_change > 0, 10000, -10000),
    colour = "grey20",
    size = 3) +
   scale_x_continuous(expand = expansion(mult = c(.3, .3))) +
  labs(x = NULL,
       y = NULL,
       title = "Month-Over-Month Change") +
  theme_minimal() +
  theme_horiz +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        plot.title = element_text(size = 11, colour = "grey20"))

p3 <- ggplot(industry_change, 
         aes(month_change_percent, reorder(industry, -year_change_percent))) +
  geom_col(fill = main_colour, alpha = 0.6) +
  geom_text(aes(label = signs(
        month_change_percent,
        format = percent,
        accuracy = 0.1,
        add_plusses = TRUE
      )),
     nudge_x = ifelse(industry_change$month_change_percent > 0, .07, -.07),
    colour = "grey20",
    size = 3) +
  scale_x_continuous(expand = expansion(mult = c(.3, .3))) +
  labs(x = NULL,
       y = NULL,
       title = "% Month-Over-Month Change") +
  theme_minimal() +
  theme_horiz +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        plot.title = element_text(size = 11, colour = "grey20"))

p4 <- ggplot(industry_change, 
         aes(year_change_percent, reorder(industry, -year_change_percent))) +
  geom_col(fill = main_colour, alpha = 0.6) +
  geom_text(aes(label = signs(
        year_change_percent,
        format = percent,
        accuracy = 0.1,
        add_plusses = TRUE
      )),
     nudge_x = ifelse(industry_change$year_change_percent > 0, .3, -.3),
    colour = "grey20",
    size = 3) +
   scale_x_continuous(expand = expansion(mult = c(.3, .3))) +
  labs(x = NULL,
       y = NULL,
       title = "% Year-Over-Year Change") +
  theme_minimal() +
  theme_horiz +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        plot.title = element_text(size = 11, colour = "grey20"))


plot_grid(p1, p2, p3, p4,
                   nrow = 1, ncol = 4,
                   rel_widths = c(2.5, 1, 1,1))
```

COVID-19
======================================================================

Row 1
-------------------------------------------------------------------------

### Month-Over-February Change in B.C. Unemployment Rate {.value-box}

```{r}
##year over year change unemployment rate
feb_change_unemployment_rate_bc <- lfc_province_tidy %>%
  filter(
    vector == "v2064705",
    date %in% c(max(date), "2020-02-01")
  ) %>%
  mutate(year_change = value - lag(value)) %>%
  filter(date == max(date))

valueBox(
  value = feb_change_unemployment_rate_bc %>%
    pull(year_change) %>%
    signs(
      format = percent,
      add_plusses = TRUE,
      accuracy = 0.1
    ),
  # icon = "fa-users-cog",
  caption = paste("Change in B.C. Unemployment Rate Since February 2020")
)
```

### Month-Over-February Change in Number of Jobs in B.C. {.value-box}

```{r}
feb_change_employment_bc <- lfc_province_tidy %>%
  filter(
    vector == "v2064701",
    date %in% c(max(date), "2020-02-01")
  ) %>%
  mutate(
    year_change = value - lag(value),
    year_change_percent = value / lag(value) - 1
  ) %>%
  filter(date == max(date))

# year over year change employment
valueBox(
  value = feb_change_employment_bc %>%
    pull(year_change) %>%
    signs(
      format = comma,
      add_plusses = TRUE
    ),
  # icon = "fa-users-cog",
  caption = paste("Change in Number of Jobs in B.C. Since February 2020")
)
```

Row 2 {data-height=250}
-------------------------------------------------------------------------

### Change in B.C. Unemployment Rate by Age & Gender Since February 2020

```{r}
feb_change_unemployment_bc_gender <- lfc_province_tidy %>%
  filter(
   date %in% c(max(date), "2020-02-01"),
    geo == "British Columbia",
    labour_force_characteristics %in% c("Unemployment rate"),
    age_group %in% c(
      # "25 years and over"
                     "15 to 24 years",
                     "25 to 54 years",
                     "55 years and over"
                     ),
    sex != "Both sexes"
  ) %>%
  mutate(feb_change = value - lag(value)) %>%
  filter(date == max(date)) %>% 
  ungroup() %>% 
  select(sex, age_group, feb_change) %>% 
    pivot_wider(names_from = sex,
                values_from = feb_change)

cols_mf <- c("Males", "Females")

  gt(feb_change_unemployment_bc_gender) %>%
  fmt_percent("Males", decimals = 1) %>% 
    fmt_percent("Females", decimals = 1) %>% 
    cols_label(
    Females = "Women",
    Males = "Men",
    age_group = "Age"
    ) %>%
    fmt(
    columns = vars(cols_mf),
    fns = function(x) {
    case_when(x == 0 ~ percent(x, accuracy = .1),
              x > 0 ~ paste(percent(x, accuracy = .1), up_arrow), 
              x < 0 ~ paste(percent(x, accuracy = .1), down_arrow))
    }
  )
```

### Change in Number of Jobs in B.C. by Job Type & Gender Since February 2020

```{r}
feb_change_employment_bc_gender <- lfc_province_tidy %>%
  filter(
    date %in% c(max(date), "2020-02-01"),
    geo == "British Columbia",
    labour_force_characteristics %in% c("Full-time employment",
                                        "Part-time employment",
                                        "Employment"),
    sex != "Both sexes",
    age_group == "15 years and over"
  ) %>%
  mutate(feb_change = value - lag(value)) %>%
  filter(date == max(date)) %>% 
  ungroup() %>% 
  select(sex, labour_force_characteristics, feb_change) %>% 
    pivot_wider(names_from = sex,
                values_from = feb_change)

cols_mf <- c("Males", "Females")

gt(feb_change_employment_bc_gender) %>%
    cols_label(
    Females = "Women",
    Males = "Men",
    labour_force_characteristics = ""
  ) %>%
    fmt(
    columns = vars(cols_mf),
    fns = function(x) {
    ifelse(x > 0, (paste(comma(x), up_arrow)), paste(comma(x), down_arrow))
    }
  )
```

Row 3 {data-height=1300}
------------------------------------------------------------------------

### Change in B.C. Industry Unemployment Rates by Age & Gender Since February 2020 

```{r}
nested_naics <- c("Forestry and logging and support activities for forestry [113, 1153]",
                  "Fishing, hunting and trapping [114]","Mining, quarrying, and oil and gas extraction [21, 2100]",
                  "Durables [321, 327, 331-339]",
                  "Non-durables [311-316, 322-326]",
                  "Wholesale trade [41]",
                  "Retail trade [44-45]",
                  "Finance and insurance [52]",
                  "Real estate and rental and leasing [53]")


cols <- c("Both sexes_15 to 24 years",
    "Females_15 to 24 years",
    "Males_15 to 24 years",
    "Both sexes_25 to 54 years",
    "Females_25 to 54 years",
    "Males_25 to 54 years",
    "Both sexes_55 years and over",
    "Females_55 years and over",
    "Males_55 years and over")
```


```{r}
industry_unemployrt_long <- lfs_industry_unadjusted_tidy %>%
  filter(
    labour_force_characteristics == "Unemployment rate",
    age_group != "15 years and over",
    date %in% c(max(date), "2020-02-01"),
    !naics %in% nested_naics) %>%
  group_by(vector) %>% 
  mutate(
    feb_change = value - lag(value)
  ) %>%
  filter(date == max(date)) %>% 
  mutate(industry = str_extract(naics, "^[^\\[]+")) %>%
  ungroup() %>% 
  select(industry, sex, age_group, feb_change) %>% 
  unite(gender_age, c(sex, age_group)) 

industry_unemployrt <- industry_unemployrt_long %>% 
  pivot_wider(names_from = gender_age,
              values_from = feb_change)

gt(industry_unemployrt,
     rowname_col = "industry") %>% 
  # tab_header(
  #   title = "Change in B.C. Unemployment Rate by Industry, Age & Gender",
  #   subtitle = paste("February to", report_month, report_year)
  # ) %>% 
   tab_spanner(
    label = "15 to 24 Years",
    columns = vars(`Both sexes_15 to 24 years`, `Females_15 to 24 years`,`Males_15 to 24 years`)
  ) %>% 
   tab_spanner(
    label = "25 to 54 Years",
    columns = vars(`Both sexes_25 to 54 years`, `Females_25 to 54 years`, `Males_25 to 54 years`)
  ) %>% 
   tab_spanner(
    label = "55 Years & Over",
    columns = vars(`Both sexes_55 years and over`, `Females_55 years and over`, `Males_55 years and over`)
  )  %>% 
    tab_source_note(
    source_note = md("[Statistics Canada Table **14-10-0022-01**: Labour force characteristics by industry, monthly, unadjusted for seasonality](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410002201)")
  ) %>% 
    cols_label(
    `Both sexes_15 to 24 years` = "Both Genders",
    `Females_15 to 24 years` = "Females",
    `Males_15 to 24 years` = "Males",
    `Both sexes_25 to 54 years` = "Both Genders",
    `Females_25 to 54 years` = "Females",
    `Males_25 to 54 years` = "Males",
    `Both sexes_55 years and over` = "Both Genders",
    `Females_55 years and over` = "Females",
    `Males_55 years and over` = "Males"
  ) %>% 
    fmt_missing(
    columns = 2:10,
    missing_text = "x"
  ) %>%
   fmt(
    columns = vars(cols),
    fns = function(x) {
    case_when(x == 0 ~ percent(x, accuracy = .1),
              x > 0 ~ paste(percent(x, accuracy = .1), up_arrow), 
              x < 0 ~ paste(percent(x, accuracy = .1), down_arrow))
    }
  )
```

Row 4 {data-height=1300}
-------------------------------------------------------------------------

### Change in Number of Industry Jobs in B.C. by Age & Gender Since February 2020 

```{r}
industry_employ_long <- lfs_industry_unadjusted_tidy %>%
  filter(
    labour_force_characteristics == "Employment",
    age_group != "15 years and over",
    date %in% c(max(date), "2020-02-01"),
    !naics %in% nested_naics) %>%
  group_by(vector) %>% 
  mutate(
    feb_change = value - lag(value)
  ) %>%
  filter(date == max(date)) %>% 
  mutate(industry = str_extract(naics, "^[^\\[]+")) %>%
  ungroup() %>% 
  select(industry, sex, age_group, feb_change) %>% 
  unite(gender_age, c(sex, age_group)) 

industry_employ <- industry_employ_long %>% 
  pivot_wider(names_from = gender_age,
              values_from = feb_change)

gt(industry_employ,
     rowname_col = "industry") %>% 
  # tab_header(
  #   title = "Change in Number of Jobs in B.C. by Industry, Age & Gender",
  #   subtitle = paste("February to", report_month, report_year)
  # ) %>% 
   tab_spanner(
    label = "15 to 24 Years",
    columns = vars(`Both sexes_15 to 24 years`, `Females_15 to 24 years`,`Males_15 to 24 years`)
  ) %>% 
   tab_spanner(
    label = "25 to 54 Years",
    columns = vars(`Both sexes_25 to 54 years`, `Females_25 to 54 years`, `Males_25 to 54 years`)
  ) %>% 
   tab_spanner(
    label = "55 Years & Over",
    columns = vars(`Both sexes_55 years and over`, `Females_55 years and over`, `Males_55 years and over`)
  )  %>% 
    tab_source_note(
    source_note = md("[Statistics Canada Table **14-10-0022-01**: Labour force characteristics by industry, monthly, unadjusted for seasonality](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410002201)")
  ) %>% 
    cols_label(
    `Both sexes_15 to 24 years` = "Both Genders",
    `Females_15 to 24 years` = "Females",
    `Males_15 to 24 years` = "Males",
    `Both sexes_25 to 54 years` = "Both Genders",
    `Females_25 to 54 years` = "Females",
    `Males_25 to 54 years` = "Males",
    `Both sexes_55 years and over` = "Both Genders",
    `Females_55 years and over` = "Females",
    `Males_55 years and over` = "Males"
  ) %>% 
    fmt_missing(
    columns = 2:10,
    missing_text = "x"
  ) %>%
   fmt(
    columns = vars(cols),
    fns = function(x) {
    ifelse(x > 0, (paste(comma(x), up_arrow)), paste(comma(x), down_arrow))
    }
  )
```

About {data-orientation=columns}
======================================================================

Column
-----------------------------------------------------------------------

Data are sourced from the [Statistics Canada Labour Force Survey (LFS)](https://www.statcan.gc.ca/eng/survey/household/3701), a monthly survey which measures the current state of the Canadian labour market. 
  
Statistics Canada Labour Force Survey Tables: 

 - [Statistics Canada Table **14-10-0287-03**: Labour force characteristics by province, monthly, seasonally adjusted](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410028703)
 - [Statistics Canada Table **14-10-0293-02**: Labour force characteristics by economic region, three-month moving average, unadjusted for seasonality](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410029302)
 - [Statistics Canada Table **14-10-0288-01**: Employment by class of worker, monthly, seasonally adjusted and unadjusted, last 5 months](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410028801)
  - [Statistics Canada Table **14-10-0355-02**: Employment by industry, monthly, seasonally adjusted](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410035502)
   - [Statistics Canada Table **14-10-0022-01**: Labour force characteristics by industry, monthly, unadjusted for seasonality](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410002201)

 <!--
 - [Statistics Canada Table **14-10-0127-01**: Reason for not looking for work, monthly, unadjusted for seasonality](https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410012701&pickMembers%5B0%5D=1.11&pickMembers%5B1%5D=3.1&pickMembers%5B2%5D=4.1) 
 -->
 
B.C. Data Catalogue:

 - [Current Census Economic Regions](https://catalogue.data.gov.bc.ca/dataset/1aebc451-a41c-496f-8b18-6f414cde93b7)

All data are released under the [Statistics Canada Open Licence](https://www.statcan.gc.ca/eng/reference/licence).


This report is built with the [`flexdashboard` R package](https://rmarkdown.rstudio.com/flexdashboard/), sourcing the Statistics Canada Labour Force Survey data using the [`cansim` R package](https://mountainmath.github.io/cansim/index.html), the Canadian provincial and territorial boundaries geospatial data using the [`cancensus` R package](https://mountainmath.github.io/cancensus/index.html) and the British Columbia economic region boundaries geospatial data using the [`bcdata` R package](https://bcgov.github.io/bcdata/).
  
The [R](https://www.r-project.org/) code is available in [bcgov GitHub](https://github.com/bcgov/labour-force-survey-digest), made available under the [Apache 2.0 licence](https://github.com/bcgov/labour-force-survey-digest/blob/master/LICENSE).
